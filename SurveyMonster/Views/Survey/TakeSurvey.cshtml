@model SurveyMonster.Models.ViewModels.QuestionNavigationViewModel
@{
    ViewData["Title"] = "Anket - " + Model.SurveyName;
    Layout = "";
}
<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>@ViewData["Title"] - Survey Monster</title>
    <link rel="stylesheet" href="~/lib/bootstrap/dist/css/bootstrap.min.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link rel="stylesheet" href="~/css/site.css" asp-append-version="true" />
    <link rel="stylesheet" href="~/css/survey-enhancements.css" asp-append-version="true" />
    <link rel="stylesheet" href="~/SurveyMonster.styles.css" asp-append-version="true" />
</head>
<body>
    <div class="container mt-2 mb-2">
        <div class="row justify-content-center">
            <div class="col-lg-10" style="width:60%">
                <div class="survey-container">
                    <!-- Survey Header -->
                    <div class="survey-header">
                        <div class="info-badge">
                            <i class="bi bi-clipboard-data me-2"></i>Anket Formu
                        </div>

                        <form asp-controller="Auth" asp-action="Logout" method="post" class="d-inline" style="float:right">
                            @Html.AntiForgeryToken()
                            <button type="submit" class="btn btn-outline-light btn-sm">
                                <i class="bi bi-box-arrow-right"></i> Çıkış
                            </button>
                        </form>
               
                        <h4 class="mb-1 fw-bold" style="position: relative;">@Model.SurveyName</h4>
                        <p class="mb-0" style="opacity: 0.9; font-size: 0.9rem;" id="questionProgress">
                            <i class="bi bi-info-circle me-2"></i>
                            Soru <span id="currentQuestionNumber">1</span> / <span id="totalQuestions">@Model.TotalQuestions</span>
                        </p>
                    </div>

                    <!-- Progress Bar -->
                    <div class="px-3 py-2" style="background: #f8f9fa;">
                        <div class="d-flex justify-content-between align-items-center mb-1">
                            <small class="text-muted fw-bold">İlerleme</small>
                            <small class="text-muted">
                                <span id="answeredCount">0</span> / <span id="totalQuestionsProgress">@Model.TotalQuestions</span> soru
                            </small>
                        </div>
                        <div class="progress-bar-custom">
                            <div class="progress-fill" id="progressFill" style="width: 0%"></div>
                        </div>
                    </div>

                    <div class="p-3">
                        @if (TempData["Error"] != null)
                        {
                            <div class="alert alert-danger border-0 shadow-sm mb-3" role="alert">
                                <i class="bi bi-exclamation-triangle me-2"></i>
                                @TempData["Error"]
                            </div>
                        }
                        @if (TempData["Warning"] != null)
                        {
                            <div class="alert alert-warning border-0 shadow-sm mb-3" role="alert">
                                <i class="bi bi-exclamation-circle me-2"></i>
                                @TempData["Warning"]
                            </div>
                        }

                        <!-- Question Container - Will be populated by JavaScript -->
                        <div id="questionContainer">
                            <div class="question-card animated">
                                <div class="d-flex align-items-start mb-3">
                                    <div class="question-number" id="questionNumber">1</div>
                                    <h6 class="question-text flex-grow-1" id="questionText">Yükleniyor...</h6>
                                </div>

                                <div class="options-container" id="optionsContainer">
                                    <!-- Options will be rendered here by JavaScript -->
                                </div>
                            </div>

                            <div class="d-flex justify-content-between align-items-center mt-3">
                                <button type="button" 
                                        id="prevBtn"
                                        class="cancel-btn"
                                        style="display: none;">
                                    <i class="bi bi-arrow-left me-2"></i>Geri
                                </button>

                                <button type="button" 
                                        id="nextBtn"
                                        class="submit-btn">
                                    İleri<i class="bi bi-arrow-right ms-2"></i>
                                </button>

                                <button type="button" 
                                        id="completeBtn"
                                        class="submit-btn"
                                        style="display: none;">
                                    <i class="bi bi-check-circle me-2"></i>Anketi Tamamla
                                </button>
                            </div>

                            <div class="text-center mt-3">
                                <small class="text-muted">
                                    <i class="bi bi-shield-check me-1"></i>
                                    Cevaplarınız güvenli bir şekilde kaydedilecektir
                                </small>
                            </div>
                        </div>

                        <!-- Hidden form for final submission -->
                        <form asp-action="SubmitSurvey" method="post" id="submitForm" style="display: none;">
                            @Html.AntiForgeryToken()
                            <input type="hidden" name="entryId" value="@Model.EntryId" id="submitEntryId" />
                            <input type="hidden" name="answersJson" id="answersJson" />
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="~/lib/jquery/dist/jquery.min.js"></script>
    <script src="~/lib/bootstrap/dist/js/bootstrap.bundle.min.js"></script>
    <script src="~/js/survey-enhancements.js" asp-append-version="true"></script>
    <script>
        // Survey data from server - loaded once
        const surveyData = {
            entryId: @Model.EntryId,
            surveyId: @Model.SurveyId,
            surveyName: '@Model.SurveyName',
            questions: @Html.Raw(System.Text.Json.JsonSerializer.Serialize(
                ((List<SurveyMonster.Models.ViewModels.QuestionViewModel>)ViewBag.AllQuestions).Select(q => new {
                    QuestionId = q.QuestionId,
                    QuestionText = q.QuestionText,
                    Order = q.Order,
                    QuestionTypeId = q.QuestionTypeId,
                    QuestionTypeName = q.QuestionTypeName,
                    Options = q.Options.Select(o => new {
                        OptionId = o.OptionId,
                        OptionText = o.OptionText,
                        Value = o.Value,
                        IsOther = o.IsOther
                    }).ToList()
                }).ToList()
            ))
        };

        // Client-side state
        let currentQuestionIndex = 0;
        let answers = {}; // { questionId: answer }

        // Initialize survey
        function initSurvey() {
            if (!surveyData.questions || surveyData.questions.length === 0) {
                alert('⚠️ Anket soruları yüklenemedi. Lütfen sayfayı yenileyin.');
                return;
            }

            renderQuestion(currentQuestionIndex);
            updateProgress();
            updateButtons();
        }

        // Render question
        function renderQuestion(index) {
            const question = surveyData.questions[index];
            if (!question) {
                console.error('Question not found at index:', index);
                return;
            }

            // Update question number and text
            document.getElementById('questionNumber').textContent = index + 1;
            document.getElementById('questionText').textContent = question.QuestionText;
            document.getElementById('currentQuestionNumber').textContent = index + 1;

            // Render options based on question type
            const optionsContainer = document.getElementById('optionsContainer');
            optionsContainer.innerHTML = '';

            const savedAnswer = answers[question.QuestionId] || '';

            if (question.QuestionTypeId === 1) {
                // Single choice (radio buttons)
                question.Options.forEach(option => {
                    // Check if this option has "other" text
                    let otherText = '';
                    if (option.IsOther && savedAnswer) {
                        const parts = savedAnswer.split('#other#');
                        if (parts.length > 1 && parts[0] == option.OptionId) {
                            otherText = parts[1];
                        }
                    }
                    
                    // Display "Diğer" if OptionText is empty and IsOther is true
                    const displayText = option.IsOther && !option.OptionText ? 'Diğer' : option.OptionText;
                    
                    const optionHtml = `
                        <div class="option-item ${savedAnswer && savedAnswer.startsWith(option.OptionId.toString()) ? 'selected' : ''}">
                            <div class="form-check">
                                <input class="form-check-input question-input"
                                       type="radio"
                                       name="currentAnswer"
                                       value="${option.OptionId}"
                                       id="option_${option.OptionId}"
                                       data-is-other="${option.IsOther}"
                                       ${savedAnswer && savedAnswer.startsWith(option.OptionId.toString()) ? 'checked' : ''} />
                                <label class="form-check-label w-100" for="option_${option.OptionId}">
                                    ${displayText}
                                </label>
                            </div>
                            ${option.IsOther ? `
                                <div class="mt-2 ms-4 other-text-container" style="display: ${otherText ? 'block' : 'none'};">
                                    <input type="text" 
                                           class="form-control other-text-input" 
                                           id="other_${option.OptionId}"
                                           placeholder="Lütfen belirtin..."
                                           value="${otherText}" />
                                </div>
                            ` : ''}
                        </div>
                    `;
                    optionsContainer.innerHTML += optionHtml;
                });
            } else if (question.QuestionTypeId === 2) {
                // Multiple choice (checkboxes)
                const selectedOptions = savedAnswer ? savedAnswer.split(';') : [];
                
                question.Options.forEach(option => {
                    // Check if this option is selected and has "other" text
                    let isChecked = false;
                    let otherText = '';
                    
                    selectedOptions.forEach(selected => {
                        if (selected.startsWith(option.OptionId + '#other#')) {
                            isChecked = true;
                            otherText = selected.split('#other#')[1];
                        } else if (selected == option.OptionId) {
                            isChecked = true;
                        }
                    });
                    
                    // Display "Diğer" if OptionText is empty and IsOther is true
                    const displayText = option.IsOther && !option.OptionText ? 'Diğer' : option.OptionText;
                    
                    const optionHtml = `
                        <div class="option-item ${isChecked ? 'selected' : ''}">
                            <div class="form-check">
                                <input class="form-check-input question-input checkbox-answer"
                                       type="checkbox"
                                       name="currentAnswer"
                                       value="${option.OptionId}"
                                       id="option_${option.OptionId}"
                                       data-is-other="${option.IsOther}"
                                       ${isChecked ? 'checked' : ''} />
                                <label class="form-check-label w-100" for="option_${option.OptionId}">
                                    ${displayText}
                                </label>
                            </div>
                            ${option.IsOther ? `
                                <div class="mt-2 ms-4 other-text-container" style="display: ${otherText ? 'block' : 'none'};">
                                    <input type="text" 
                                           class="form-control other-text-input" 
                                           id="other_${option.OptionId}"
                                           placeholder="Lütfen belirtin..."
                                           value="${otherText}" />
                                </div>
                            ` : ''}
                        </div>
                    `;
                    optionsContainer.innerHTML += optionHtml;
                });
            } else if (question.QuestionTypeId === 3) {
                // Open ended (textarea)
                const textareaHtml = `
                    <div class="mb-3">
                        <textarea class="form-control" 
                                  id="openEndedAnswer"
                                  name="currentAnswer"
                                  rows="5" 
                                  placeholder="Cevabınızı buraya yazın...">${savedAnswer || ''}</textarea>
                    </div>
                `;
                optionsContainer.innerHTML = textareaHtml;
            }

            // Add event listeners for visual feedback and "other" option handling
            setTimeout(() => {
                document.querySelectorAll('.option-item input[type="radio"], .option-item input[type="checkbox"]').forEach(input => {
                    input.addEventListener('change', function() {
                        const optionItem = this.closest('.option-item');
                        if (!optionItem) return;
                        
                        if (this.type === 'radio') {
                            // Hide all other text inputs for radio buttons
                            document.querySelectorAll('.other-text-container').forEach(container => {
                                container.style.display = 'none';
                            });
                            
                            document.querySelectorAll('.option-item').forEach(item => {
                                item.classList.remove('selected');
                            });
                        }
                        
                        if (this.checked) {
                            optionItem.classList.add('selected');
                            
                            // Show "other" text input if this is an "other" option
                            if (this.dataset.isOther === 'true') {
                                const otherContainer = optionItem.querySelector('.other-text-container');
                                if (otherContainer) {
                                    otherContainer.style.display = 'block';
                                    const otherInput = otherContainer.querySelector('.other-text-input');
                                    if (otherInput) {
                                        otherInput.focus();
                                    }
                                }
                            }
                        } else {
                            optionItem.classList.remove('selected');
                            
                            // Hide "other" text input if unchecked
                            if (this.dataset.isOther === 'true') {
                                const otherContainer = optionItem.querySelector('.other-text-container');
                                if (otherContainer) {
                                    otherContainer.style.display = 'none';
                                    const otherInput = otherContainer.querySelector('.other-text-input');
                                    if (otherInput) {
                                        otherInput.value = '';
                                    }
                                }
                            }
                        }
                    });
                });
            }, 100);
        }

        // Save current answer
        function saveCurrentAnswer() {
            const question = surveyData.questions[currentQuestionIndex];
            if (!question) return;

            let answer = '';

            if (question.QuestionTypeId === 1) {
                // Single choice
                const selected = document.querySelector('input[name="currentAnswer"]:checked');
                if (selected) {
                    answer = selected.value;
                    
                    // Check if this is an "other" option with text
                    if (selected.dataset.isOther === 'true') {
                        const otherInput = document.getElementById('other_' + selected.value);
                        if (otherInput && otherInput.value.trim()) {
                            answer = selected.value + '#other#' + otherInput.value.trim();
                        }
                    }
                }
            } else if (question.QuestionTypeId === 2) {
                // Multiple choice
                const selected = document.querySelectorAll('.checkbox-answer:checked');
                if (selected.length > 0) {
                    const answers = Array.from(selected).map(cb => {
                        let value = cb.value;
                        
                        // Check if this is an "other" option with text
                        if (cb.dataset.isOther === 'true') {
                            const otherInput = document.getElementById('other_' + cb.value);
                            if (otherInput && otherInput.value.trim()) {
                                value = cb.value + '#other#' + otherInput.value.trim();
                            }
                        }
                        
                        return value;
                    });
                    answer = answers.join(';');
                }
            } else if (question.QuestionTypeId === 3) {
                // Open ended
                const textarea = document.getElementById('openEndedAnswer');
                if (textarea) {
                    answer = textarea.value;
                }
            }

            // Save answer (even if empty)
            answers[question.QuestionId] = answer;
            updateProgress();
        }

        // Navigate to next question
        function nextQuestion() {
            saveCurrentAnswer();
            
            if (currentQuestionIndex < surveyData.questions.length - 1) {
                currentQuestionIndex++;
                renderQuestion(currentQuestionIndex);
                updateButtons();
            }
        }

        // Navigate to previous question
        function prevQuestion() {
            saveCurrentAnswer();
            
            if (currentQuestionIndex > 0) {
                currentQuestionIndex--;
                renderQuestion(currentQuestionIndex);
                updateButtons();
            }
        }

        // Update button visibility
        function updateButtons() {
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');
            const completeBtn = document.getElementById('completeBtn');

            // Show/hide prev button
            if (currentQuestionIndex > 0) {
                prevBtn.style.display = 'block';
            } else {
                prevBtn.style.display = 'none';
            }

            // Show/hide next/complete button
            if (currentQuestionIndex < surveyData.questions.length - 1) {
                nextBtn.style.display = 'block';
                completeBtn.style.display = 'none';
            } else {
                nextBtn.style.display = 'none';
                completeBtn.style.display = 'block';
            }
        }

        // Update progress bar
        function updateProgress() {
            const answeredCount = Object.keys(answers).filter(key => answers[key] !== '').length;
            const totalQuestions = surveyData.questions.length;
            const percentage = totalQuestions > 0 ? (answeredCount / totalQuestions) * 100 : 0;

            document.getElementById('answeredCount').textContent = answeredCount;
            document.getElementById('progressFill').style.width = percentage + '%';
        }

        // Complete survey
        function completeSurvey() {
            saveCurrentAnswer();

            const answeredCount = Object.keys(answers).filter(key => answers[key] !== '').length;
            const totalQuestions = surveyData.questions.length;

            // Check if there are unanswered questions
            if (answeredCount < totalQuestions) {
                const unansweredCount = totalQuestions - answeredCount;
                const confirmMessage = `⚠️ Dikkat!\n\n${unansweredCount} soru henüz cevaplanmadı.\n\nYine de anketi tamamlamak istiyor musunuz?`;
                
                if (!confirm(confirmMessage)) {
                    return;
                }
            }

            // Final confirmation
            if (confirm('✅ Anketi tamamlamak istediğinize emin misiniz?\n\nCevaplarınız kaydedilecektir.')) {
                // Prepare answers JSON
                document.getElementById('answersJson').value = JSON.stringify(answers);
                
                // Submit form
                document.getElementById('submitForm').submit();
            }
        }

        // Event listeners
        document.getElementById('prevBtn').addEventListener('click', prevQuestion);
        document.getElementById('nextBtn').addEventListener('click', nextQuestion);
        document.getElementById('completeBtn').addEventListener('click', completeSurvey);

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', initSurvey);
    </script>
</body>
</html>
